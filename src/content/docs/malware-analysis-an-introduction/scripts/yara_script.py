import os
import subprocess

# Define the directory to process
directory_path = r"C:\Users\IronMan\Desktop\Tools\Yara\rules-master"

# Define the file extension to filter by (e.g., '.txt')
file_extension = ".yar"

# Output log file
output_log = r"./yara_scan_ouput_powershell.zip.txt"

# Check if the directory exists
if not os.path.exists(directory_path):
    print(f"The directory {directory_path} does not exist.")
    exit()

# Ensure the output log file exists and is empty initially
with open(output_log, 'w') as f:
    f.write("")

# Define the command to execute on each file
def process_file(file_path):
    print(f"Processing file: {file_path}")
    # Replace 'echo' with your desired command
    # In Windows, 'echo' will print the file path
    result = subprocess.run(['cmd', '/c', 'yara64', file_path, r"C:\Users\IronMan\Downloads\powershell.zip"], capture_output=True, text=True)
    output = result.stdout.strip()

    # Append the filename and command output to the log file
    if output:
        with open(output_log, 'a') as log_file:
            log_file.write(f"Filename: {file_path}\n")
            log_file.write(f"Output:\n{output}\n\n")

# Walk through the files in the directory
for root, _, files in os.walk(directory_path):
    for file in files:
        # Filter by file extension
        if file.endswith(file_extension):
            file_path = os.path.join(root, file)
            process_file(file_path)

print(f"All matching files have been processed. Output saved to {output_log}.")
