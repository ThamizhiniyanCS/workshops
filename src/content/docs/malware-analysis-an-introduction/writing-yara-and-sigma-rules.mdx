---
title: "Writing Yara and Sigma Rules"
description: "Overview of the Malware Analysis - An Introduction workshop."
sidebar:
  order: 34
---

import { LinkCard } from "@astrojs/starlight/components";
import { Code } from "@astrojs/starlight/components";

## Yara

### What is Yara?

[Yara](https://yara.readthedocs.io/en/stable/index.html) is a tool aimed at (but not limited to) helping malware researchers to identify and classify malware samples.

- Yara files are stored with `.yar` extension
- Yara files follow YAML syntax

<LinkCard
  title="Getting started with Yara"
  description="Offical Yara Documentation"
  href="https://yara.readthedocs.io/en/latest/gettingstarted.html"
/>

### Example Yara rule

import ExampleYaraRule from "scripts/example_yara_rule.yar?raw";

<Code code={ExampleYaraRule} lang="yaml" title="example_rule.yar" />

### Components of Yara Rule

- **Meta**
  - Optional Section
  - Information that we define like author name, references, etc.,
  - Doesnâ€™t affect the YARA rules
- **Rule Identifiers**
  - Required Section
  - Name that describes the rule
  - Case Sensitive, Max 128 characters
  - `^[A-Za-z_][A-Za-z0-9_]{1,127}$` -> Regex Pattern to match Rule Identifiers
  - Example: `rule Rule_Identifier_123`
- **String Definition**
  - Optional Section
  - strings that are part of the rule
    - text, hexadecimal, regular expression
  - This section can be omitted if the rule does not rely on any strings.
  - `^$[A-Za-z0-9_]*` -> Regex Pattern to match Strings Identifiers
  - These variables are used in the condition section
  - Example: `$String_1`
- **Condition Section**
  - Required Section
  - Logic of the rule
  - Contains Boolean Expressions based on which the rules matches or not

### Manually Writing a Yara Rule

We will be writing a Yara rule manually for the `Windows Powershell.lnk` malware.

For writing a Yara rule, first we should identify unique and suspicious strings from a malware. In the **Indicators of Compromise** section, for the `windows_powershell.lnk` file, we have identified unique base64 encoded string. We can use that here. Here is the simple yara rule with that base64 encoded string:

import Base64YaraRule from "scripts/base64_yara_rule.yar?raw";

<Code code={Base64YaraRule} lang="yaml" title="base64_rule.yar" />

### Generating Yara Rule using yarGen

Now let's generate Yara rule for the same `windows_powershell.lnk` file using [yarGen](https://github.com/Neo23x0/yarGen). You can find the installation instructions [here](https://github.com/Neo23x0/yarGen?tab=readme-ov-file#installation).

### Resources for Yara Rules

- [Repository of yara rules](https://github.com/Yara-Rules/rules/)

- [How To Write Simple But Sound Yara Rules Part - 1](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/)

- [How To Write Simple But Sound Yara Rules Part - 2](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/)

- [How To Write Simple But Sound Yara Rules Part - 3](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)

- [How to post-process YARA rules generated by yarGen](https://cyb3rops.medium.com/how-to-post-process-yara-rules-generated-by-yargen-121d29322282)

- [Youtube - Classify Malware with Yara by John Hammond ](https://www.youtube.com/watch?v=fu71CljrxsU)

- [Writing Better Yara Rules in 2023](https://www.hexacorn.com/blog/2023/08/26/writing-better-yara-rules-in-2023/)

## Sigma

### What is Sigma?

[Sigma](https://sigmahq.io/) rules are a generic, open-source, and structured detection format used in cybersecurity to detect relevant log events in a simple and shareable way. They are designed to be platform-agnostic, allowing security teams to write a detection once and use it across various Security Information and Event Management (SIEM) systems.

### Example Sigma rule

Here's a simple example of a **Sigma rule** that detects suspicious PowerShell execution in a Windows environment.

import ExampleSigmaRule from "scripts/example_sigma_rule.yaml?raw";

<Code code={ExampleSigmaRule} lang="yaml" title="example_rule.yaml" />

1. **Logsource**: Specifies the type of logs to analyze, e.g., process creation on Windows.
2. **Detection**: Looks for processes where:
   - The executed process is `powershell.exe`.
   - The command line includes keywords like `Invoke-WebRequest` or `DownloadString`.
3. **Fields**: Defines the fields to be returned (e.g., `Image` and `CommandLine`).
4. **Level**: Indicates the severity of the detection (`high`).

### Resources for Sigma Rules

- [Main Sigma Rule Repository](https://github.com/SigmaHQ/sigma)

- [Official Resources](https://sigmahq.io/resources/)
